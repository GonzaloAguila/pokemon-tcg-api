generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Enums
// =============================================================================

enum UserRole {
  user
  admin
  superadmin
}

enum AuthProvider {
  local
  google
  discord
}

// =============================================================================
// User & Auth
// =============================================================================

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  username     String  @unique
  passwordHash String?

  // Auth
  role       UserRole     @default(user)
  provider   AuthProvider @default(local)
  providerId String?

  // Session management
  refreshToken String? @db.Text
  tokenVersion Int     @default(0)

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Email verification
  emailVerified          Boolean   @default(false)
  verificationToken      String?   @unique
  verificationTokenExpiry DateTime?

  // Account status
  status          String    @default("active") // "active" | "banned" | "suspended"
  bannedAt        DateTime?
  bannedReason    String?
  suspendedUntil  DateTime?
  suspendedReason String?

  // Security
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?

  // Legal
  termsAcceptedAt DateTime?

  // Profile
  avatarUrl      String?
  avatarPresetId String?

  // Economy
  coins     Int @default(0)
  coupons   Int @default(0)
  rareCandy Int @default(0)

  // Level / XP
  level      Int @default(1)
  experience Int @default(0)

  // Daily rewards — server-side timestamps (UTC)
  lastDailyCoinsAt DateTime?
  lastWheelSpinAt  DateTime?
  lastSlotSpinAt   DateTime?

  // Permissions / Restrictions (JSON array of permission strings)
  permissions Json @default("[]")

  // Active cosmetics
  activeCoinId     String? @default("eevee")
  activeCardBackId String? @default("default")
  activeAvatarId   String? @default("collector")
  activePlaymatId  String? @default("field")

  // Starter deck color chosen at signup
  starterColor String?

  // Deck slots
  maxDeckSlots Int @default(3)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stats            UserStats?
  medals           UserMedal[]
  achievements     UserAchievement[]
  decks            Deck[]
  matchesAsPlayer1 Match[]        @relation("Player1")
  matchesAsPlayer2 Match[]        @relation("Player2")
  matchesWon       Match[]        @relation("Winner")
  roomsAsPlayer1   GameRoom[]     @relation("RoomPlayer1")
  roomsAsPlayer2   GameRoom[]     @relation("RoomPlayer2")
  cards            UserCard[]
  transactions     Transaction[]
  ownedCoins       UserCoin[]
  ownedCardBacks   UserCardBack[]
  ownedAvatars     UserAvatar[]
  ownedCardSkins   UserCardSkin[]
  ownedPlaymats    UserPlaymat[]
  battlePasses     UserBattlePass[]
  dailyPurchases   DailyPurchase[]
  chatMessages     ChatMessage[]
  sentMessages     SystemMessage[] @relation("SentMessages")
  receivedMessages SystemMessage[] @relation("ReceivedMessages")
  messageReads     MessageRead[]

  @@index([providerId, provider])
  @@map("users")
}

// =============================================================================
// Decks & Collection
// =============================================================================

model Deck {
  id        String   @id @default(uuid())
  name      String
  cards     Json // Array of { cardDefId: string, quantity: number }
  isValid   Boolean  @default(false) // 60 cards, max 4 of each
  isActive  Boolean  @default(false)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isActive])
  @@map("decks")
}

// =============================================================================
// Matches & Game State
// =============================================================================

model Match {
  id     String @id @default(uuid())
  status String @default("waiting") // waiting, playing, finished, abandoned

  // Players
  player1Id String
  player1   User    @relation("Player1", fields: [player1Id], references: [id])
  player2Id String?
  player2   User?   @relation("Player2", fields: [player2Id], references: [id])

  // Result
  winnerId  String?
  winner    User?   @relation("Winner", fields: [winnerId], references: [id])
  winReason String? // "prizes", "deck_out", "no_pokemon", "forfeit"

  // Game data (for reconnection & replay)
  gameState  Json? // Full GameState JSON
  replayData Json? // Array of GameEvents for replay

  // Timestamps
  createdAt  DateTime  @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  // Room relation
  room GameRoom?

  @@map("matches")
}

// =============================================================================
// Matchmaking & Rooms
// =============================================================================

model GameRoom {
  id     String  @id @default(uuid())
  type   String  @default("casual") // casual, ranked, event, private
  status String  @default("waiting") // waiting, ready, playing, finished
  code   String? @unique // For private rooms (e.g., "ABC123")

  // Players
  player1Id       String?
  player1         User?   @relation("RoomPlayer1", fields: [player1Id], references: [id])
  player1Ready    Boolean @default(false)
  player1SocketId String?

  player2Id       String?
  player2         User?   @relation("RoomPlayer2", fields: [player2Id], references: [id])
  player2Ready    Boolean @default(false)
  player2SocketId String?

  // Match link
  matchId String? @unique
  match   Match?  @relation(fields: [matchId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("game_rooms")
}

// =============================================================================
// Card Collection
// =============================================================================

model UserCard {
  id        String @id @default(uuid())
  userId    String
  cardDefId String // Reference to card definition (e.g., "base-25")
  quantity  Int    @default(1)
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, cardDefId])
  @@map("user_cards")
}

// =============================================================================
// Economy — Transaction Log
// =============================================================================

model Transaction {
  id           String   @id @default(uuid())
  userId       String
  type         String // "victory", "daily_login", "achievement", "pack_purchase", "trade", "wheel_spin", "slot_spin"
  description  String
  amount       Int // positive = income, negative = expense
  balanceAfter Int // snapshot of balance after transaction
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("transactions")
}

// =============================================================================
// Collectibles — Coins & Card Backs
// =============================================================================

model UserCoin {
  id         String   @id @default(uuid())
  userId     String
  coinId     String // e.g. "charizard", "pikachu"
  obtainedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, coinId])
  @@map("user_coins")
}

model UserCardBack {
  id         String   @id @default(uuid())
  userId     String
  cardBackId String // e.g. "galaxy", "team-rocket"
  obtainedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, cardBackId])
  @@map("user_card_backs")
}

model UserAvatar {
  id         String   @id @default(uuid())
  userId     String
  avatarId   String // e.g. "collector", "girl", "bellsprout", "pikachu"
  obtainedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, avatarId])
  @@map("user_avatars")
}

model UserCardSkin {
  id         String   @id @default(uuid())
  userId     String
  skinId     String // e.g. "alakazam-glitch", "wigglytuff-rainbow"
  obtainedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skinId])
  @@map("user_card_skins")
}

model UserPlaymat {
  id         String   @id @default(uuid())
  userId     String
  playmatId  String
  obtainedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, playmatId])
  @@map("user_playmats")
}

// =============================================================================
// Battle Pass
// =============================================================================

enum BattlePassStatus {
  active
  expired
  upcoming
}

model BattlePass {
  id           String           @id @default(uuid())
  slug         String           @unique
  name         String
  description  String           @default("")
  imageUrl     String           @default("")
  durationDays Int              @default(30)
  premiumPrice Int              @default(2000)
  status       BattlePassStatus @default(active)
  rewards      Json             @default("[]")
  year         Int?
  month        Int?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  userPasses   UserBattlePass[]

  @@unique([year, month])
  @@index([status])
  @@map("battle_passes")
}

model UserBattlePass {
  id             String                 @id @default(uuid())
  userId         String
  battlePassId   String
  activatedAt    DateTime               @default(now())
  isPremium      Boolean                @default(false)
  upgradedAt     DateTime?
  user           User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  battlePass     BattlePass             @relation(fields: [battlePassId], references: [id], onDelete: Cascade)
  claimedRewards UserBattlePassReward[]
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@unique([userId, battlePassId])
  @@index([userId])
  @@map("user_battle_passes")
}

model UserBattlePassReward {
  id               String         @id @default(uuid())
  userBattlePassId String
  day              Int
  track            String
  claimedAt        DateTime       @default(now())
  userBattlePass   UserBattlePass @relation(fields: [userBattlePassId], references: [id], onDelete: Cascade)

  @@unique([userBattlePassId, day, track])
  @@map("user_battle_pass_rewards")
}

// =============================================================================
// Daily Purchases (one-time daily market buys)
// =============================================================================

model DailyPurchase {
  id        String   @id @default(uuid())
  userId    String
  itemKey   String   // e.g. "card:base-25", "cosmetic:coin:charizard"
  date      String   // "2026-02-09" (UTC date string)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemKey, date])
  @@index([userId, date])
  @@map("daily_purchases")
}

// =============================================================================
// User Stats (1:1)
// =============================================================================

model UserStats {
  id            String @id @default(uuid())
  userId        String @unique
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  normalWins    Int    @default(0)
  normalLosses  Int    @default(0)
  rankedWins    Int    @default(0)
  rankedLosses  Int    @default(0)
  draftWins     Int    @default(0)
  draftLosses   Int    @default(0)
  currentStreak Int    @default(0)
  bestStreak    Int    @default(0)

  @@map("user_stats")
}

// =============================================================================
// User Medals
// =============================================================================

model UserMedal {
  id         String   @id @default(uuid())
  userId     String
  medalId    String
  unlockedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, medalId])
  @@map("user_medals")
}

// =============================================================================
// User Achievements
// =============================================================================

model UserAchievement {
  id            String    @id @default(uuid())
  userId        String
  achievementId String
  progress      Int       @default(0)
  unlockedAt    DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// =============================================================================
// System Messages
// =============================================================================

model SystemMessage {
  id          String   @id @default(uuid())
  type        String   // "broadcast" | "personal"
  title       String   @db.VarChar(200)
  content     String   @db.VarChar(2000)
  category    String   @default("info") // "info" | "reward" | "penalty" | "news" | "maintenance"
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  recipientId String?  // null = broadcast, specific userId = personal
  recipient   User?    @relation("ReceivedMessages", fields: [recipientId], references: [id])
  metadata    Json?    // optional payload: { coins: 500, reason: "..." }
  createdAt   DateTime @default(now())

  reads MessageRead[]

  @@index([recipientId, createdAt])
  @@index([type, createdAt])
  @@map("system_messages")
}

model MessageRead {
  id        String        @id @default(uuid())
  messageId String
  message   SystemMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt    DateTime      @default(now())

  @@unique([messageId, userId])
  @@index([userId])
  @@map("message_reads")
}

// =============================================================================
// Chat
// =============================================================================

model ChatMessage {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String   @db.VarChar(500)
  type      String   @default("text")
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("chat_messages")
}

// =============================================================================
// Waitlist (landing page email collection)
// =============================================================================

model WaitlistEntry {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())

  @@map("waitlist_entries")
}
